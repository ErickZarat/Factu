<!DOCTYPE html>
<html>
<head>
  <% include /partial/head %>
  <title>Usuarios</title>
</head>
<body>
  <% include /partial/header %>

  <div class="container">

    <div id="fabButton" class="fixed-action-btn" style="bottom: 10%; right: 5%;">
      <a id="btnAdd" class="modal-trigger waves-effect waves-light btn-large red btn-floating" href="#mdlNuevo">
        <i class="large material-icons">add</i>
      </a>
    </div>

    <div class="card grey lighten-4 hoverable valign card-margin">
      <div class="progress" id="progressBar">
        <div class="indeterminate"></div>
      </div>
      <div class="card-content black-text">
        <span class="card-title">Usuarios</span>
        <br/><br/>
        <table class="striped responsive-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombres</th>
              <th>Usuario</th>
              <th>Email</th>
              <th>Agregado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tblUsuarios">

          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!--  MODALS  -->

<!-- NUEVO USUARIO -->
<div id="mdlNuevo" class="modal modal-fixed-footer">
  <div class="modal-content">
      <div class="valign">
        <h4>Nuevo Usuario</h4>
        <div class="row margin-on-modal">
					<div class="input-field col s12">
						<i class="material-icons prefix">face</i>
						<input id="txtName" type="text" class="validate" required>
						<label for="txtName" style="text-align: left;">Nombre</label>
					</div>
				</div>
        <div class="row margin-on-modal">
					<div class="input-field col s12">
						<i class="material-icons prefix">account_circle</i>
						<input id="txtUsername" type="text" class="validate" required>
						<label for="txtUsername" style="text-align: left;">Usuario</label>
					</div>
				</div>
        <div class="row margin-on-modal">
					<div class="input-field col s12">
						<i class="material-icons prefix">email</i>
						<input id="txtEmail" type="email" class="validate" required>
						<label for="txtEmail" style="text-align: left;">Email</label>
					</div>
				</div>
				<div class="row margin-on-modal">
					<div class="input-field col s12">
						<i class="material-icons prefix">lock</i>
						<input id="txtPassword" type="password" class="validate" required>
						<label for="txtPassword" style="text-align: left;">Password</label>
					</div>
				</div>

      </div>
  </div>
  <div class="modal-footer">
    <button class="modal-action modal-close waves-effect waves-green btn-flat" id="btnAgregar">Agregar</button>
    <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat ">Cancelar</a>
  </div>
</div>

<!-- EDITAR USUARIO -->
<div id="mdlEditar" class="modal modal-fixed-footer">
  <div class="modal-content">
      <div class="valign">
        <h4>Modificar Usuario</h4>
        <div class="row margin-on-modal">
					<div class="input-field col s12">
						<i class="material-icons prefix">face</i>
						<input id="txtEdName" type="text" class="validate" required>
						<label for="txtEdName" style="text-align: left;">Nombre</label>
					</div>
				</div>
        <div class="row margin-on-modal">
					<div class="input-field col s12">
						<i class="material-icons prefix">account_circle</i>
						<input id="txtEdUsername" type="text" class="validate" required>
						<label for="txtEdUsername" style="text-align: left;">Usuario</label>
					</div>
				</div>
        <div class="row margin-on-modal">
					<div class="input-field col s12">
						<i class="material-icons prefix">email</i>
						<input id="txtEdEmail" type="email" class="validate" required>
						<label for="txtEdEmail" style="text-align: left;">Email</label>
					</div>
				</div>
				<div class="row margin-on-modal">
					<div class="input-field col s12">
						<i class="material-icons prefix">lock</i>
						<input id="txtEdPassword" type="password" class="validate" required>
						<label for="txtEdPassword" style="text-align: left;">Password</label>
					</div>
				</div>

      </div>
  </div>
  <div class="modal-footer">
    <button class="modal-action modal-close waves-effect waves-green btn-flat" id="btnModificar">Modificar</button>
    <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat ">Cancelar</a>
  </div>
</div>

  <% include /partial/footer %>
  <script type="text/javascript">

  var uri = 'http://localhost:3001/api/v1/usuario';


  $('#progressBar').show();

  function editarPass(id){

  }

  function eliminar(id){
    $('#').modal('open');
    $('#btnEliminar').click(function(){

    ajax({
        url: uri,
        headers: {"x-access-token": window.localStorage.getItem('token')},
        data: {id: id},
        error: function(){
          alert('error en peticion');
        },
        success: function(data){
          Materialize.toast(data.msg, 3000, 'rounded', function(){location.reload();})
        },
        type: 'DELETE'
      });

    });
  }

  function editar(id){
    $('#mdlEditar').modal('open');

    $.ajax({
      url: uri+'/'+id,
      type: 'GET',
      success: function(data){
        $('#txtEdName').val(data.nombre);
        $('#txtEdEmail').val(data.email);
        $('#txtEdFecha').val(data.agregado);
        $('#txtEdUsername').val(data.username);
        $('#txtEdPassword').val(data.passwd);
      },
      headers: {"x-access-token": window.localStorage.getItem('token')},
      error: function(){
        alerta('error en peticion');
      }

    });

    $('#btnModificar').click(function(){
      var usr = {
        id: id,
        nombre: $('#txtEdName').val(),
        email: $('#txtEdEmail').val(),
        agregado: $('#txtEdFecha').val(),
        username: $('#txtEdUsername').val(),
        passwd: $('#txtEdPassword').val()
      }

      $.ajax({
        url: uri,
        headers: {"x-access-token": window.localStorage.getItem('token')},
        data: usr,
        error: function(){
          alert('error en peticion');
        },
        success: function(data){
          Materialize.toast(data.msg, 3000, 'rounded', function(){location.reload();})
        },
        type: 'PUT'
      });
    });
  }

  $(document).ready(function(){
    //Peticion de usuario
    window.localStorage.setItem('token', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjb21wYW55IjoiU2hha2VUcmVuZCIsImlhdCI6MTQ4MzY2NTIxMn0.EEUq2kXdRy3_lLjQbkv48GIlpVc5PHTOpF2UAs6M6Ko')
    $.ajax({
      url: uri,
      headers: {"x-access-token": window.localStorage.getItem('token')},
      error: function() {
        alert('Error en peticion');
      },
      success: function(data) {
        $.each(data, function(i, value){
          row = '<tr><td>'+value.id+'</td><td>'+value.nombre+'</td><td>'+value.username+'</td><td>'+value.email+'</td><td>'+formatDate(value.agregado)+'</td>'
          + '<td><button class="btn-floating btn-flat tooltipped" data-position="bottom" data-delay="50" data-tooltip="Editar" onclick="editar('+value.id+')"><i class="material-icons blue-grey-text">edit</i></button>'
          + '<button class="btn-floating btn-flat tooltipped" data-position="bottom" data-delay="50" data-tooltip="Editar ContraseÃ±a" onclick="editarPass('+value.id+')"><i class="material-icons blue-grey-text">settings</i></button>'
          + '<button class="tooltipped btn-floating btn-flat" data-position="bottom" data-delay="50" data-tooltip="Eliminar" onclick="eliminar('+value.id+')"><i class="material-icons blue-grey-text">delete</i></button>' +'</td></tr>';
          $('#tblUsuarios').append(row);
          row = '';
        });
        $('#progressBar').hide();
      },
      type: 'GET'
    });

    $('#btnAgregar').click(function(){
      var usr = {
        nombre: $('#txtName').val(),
        email: $('#txtEmail').val(),
        agregado: getCurrentDate(),
        username: $('#txtUsername').val(),
        passwd: $('#txtPassword').val()
      }

      $.ajax({
        url: uri,
        headers: {"x-access-token": window.localStorage.getItem('token')},
        data: usr,
        error: function(){
          alert('error en peticion');
        },
        success: function(data){
          Materialize.toast(data.msg, 3000, 'rounded', function(){location.reload();})
        },
        type: 'POST'
      });
    });





  });
  </script>
</body>
</html>
