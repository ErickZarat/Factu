<!DOCTYPE html>
<html>
<head>
  <title>Reporte Factura</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/css/materialize.min.css">
</head>
<body>
  <div class="container" id="divPrint">
    <div class="container-flud">

      <div class="center">
        <div class="row">
          <div class="col s4">
            <img src="" alt="LOGO" class="left" />
          </div>
          <div class="col s4">
            <h5 id="txtEmpresa"></h5>
            <p id="txtLocalizacion"></p>
            <p id="txtTelefono"></p>
            <p id="txtEmail"></p>
          </div>
          <div class="col s4">
            <h4 id="txtNumFac" class="right"></h4>
          </div>
        </div>


      </div>


      <table>
        <thead class="black white-text">
          <th>Facturar A</th>
        </thead>
        <tbody id="tblCliente">

        </tbody>
      </table>

      <table>
        <thead class="black white-text">
          <th>Vendedor</th>
          <th>Fecha</th>
          <th>Forma de Pago</th>
        </thead>
        <tbody id="tblVendedor"></tbody>
      </table>

      <table class="striped">
        <thead class="black white-text">
          <th>Cantidad</th>
          <th>Descripcion</th>
          <th>Precio Unit.</th>
          <th>Precio Total</th>
          <th></th>
        </thead>
        <tbody id="tblDescripcion"></tbody>
      </table>

      <p class="center"><strong>!Gracias por su compra!</strong></p>
    </div>

  </div>

  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/js/materialize.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.debug.js"></script>
<script src="https://github.com/niklasvh/html2canvas/releases/download/0.5.0-alpha1/html2canvas.js" charset="utf-8"></script>
  <script type="text/javascript">
  var server = 'http://localhost:3001/api/v1/'
  var uri = {
    conf: server + 'configuracion',
    prodfact: server + 'prodfact',
    factura: server + 'factura'
  }
  var
   form = $('body'),
   cache_width = form.width(),
   a4 = [595.28, 841.89];

  function createPDF() {
    getCanvas().then(function(canvas) {
     var
      img = canvas.toDataURL("image/png"),
      doc = new jsPDF({
       unit: 'px',
       format: 'a4'
      });
     doc.addImage(img, 'JPEG', 0, 0);
     doc.save("fac-"+ getUrlParameter('facturaId') + ".pdf");
     form.width(cache_width);
    });
   }

   // create canvas object
   function getCanvas() {
    form.width((a4[0] * 1.33333) - 80).css('max-width', 'none');
    return html2canvas(form, {
     imageTimeout: 2000,
     removeContainer: true
    });
   }

  function agregarProductoTabla(value, precioT){
    var row = '<tr><td>'+value.cant+'</td><td>'+value.producto+'</td><td>'+value.precio+'</td><td>'+precioT+'</td></tr>'
    $('#tblDescripcion').append(row);
    row = '';
  }

  function actualizarTabla(data){
    $('#tblDescripcion tr').remove();

    var subtotal = 0;
    var rows = '';
    $.each(data, function(i, value){
      precioT = value.precio * value.cant;
      agregarProductoTabla(value, precioT);

      subtotal += precioT;
    });
    var iva = (JSON.parse(window.localStorage.getItem('config')).iva / 100) * subtotal;
    var total = subtotal + iva;
    var rowsTotal = '<tr><td/><td/><td/><td><strong>SubTotal Q</strong></td><td>'+subtotal+'</td></tr>'
    +'<tr><td/><td/><td/><td><strong>IVA(12)% Q</strong></td><td>'+iva+'</td></tr>'
    +'<tr><td/><td/><td/><td><strong>TOTAL Q</strong></td><td id="tdTotal">'+total+'</td></tr>'
    $('#tblDescripcion').append(rowsTotal);
  }

  var getUrlParameter = function getUrlParameter(sParam) {
    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
    sURLVariables = sPageURL.split('&'),
    sParameterName,
    i;

    for (i = 0; i < sURLVariables.length; i++) {
      sParameterName = sURLVariables[i].split('=');

      if (sParameterName[0] === sParam) {
        return sParameterName[1] === undefined ? true : sParameterName[1];
      }
    }
  };

  function formatDate(date){
    var d = new Date(date);
    console.log(date);
    return  (d.getDate()) + '/' +(d.getMonth() + 1) + '/' + d.getFullYear();
  }

  $(document).ready(function(){
    $.ajax({
      url: uri.conf,
      type: 'GET',
      headers: {"x-access-token": window.localStorage.getItem('token')},
      success: function(data){
        $('#txtEmpresa').text(data.nombre);
        $('#txtLocalizacion').text(data.direccion + ', ' + data.ciudad + ' ' + data.region );
        $('#txtTelefono').text("Telefono: " + data.telefono);
        $('#txtEmail').text('Email'+data.email);
      }, error: function(){
        alert('error en peticion');
      }
    });

    $.ajax({
      url: uri.factura + '/' + getUrlParameter('facturaId'),
      type: 'GET',
      headers: {"x-access-token": window.localStorage.getItem('token')},
      success: function(data){
        $('#tblCliente').append('<tr><td>'+data.nombreCliente+'</td></tr>');
        $('#tblVendedor').append('<tr><td>'+data.nombreVendedor+'</td><td>'+formatDate(data.fecha)+'</td></tr>');
        $('#txtNumFac').text('Factura #' + data.id);
        $.ajax({
          url: uri.prodfact + '/' + getUrlParameter('facturaId'),
          type: 'GET',
          headers: {"x-access-token": window.localStorage.getItem('token')},
          success: function(data){
            actualizarTabla(data);
            $('body').scrollTop(0);
            createPDF();
          }, error: function(){
            alert('error en peticion');
          }
        });


      }, error: function(){
        alert('error en peticion');
      }
    });

  });

  </script>
</body>

</html>
